{% extends "base.html" %}
{% block title %}Users - Amphoraxe Auth{% endblock %}

{% block content %}
<div class="page-title">
    <h2>Users</h2>
    <button class="btn btn-primary" onclick="showCreateModal()">Create User</button>
</div>

<div class="filters">
    <div class="tab-filters">
        <button class="tab-btn active" data-status="">All</button>
        <button class="tab-btn" data-status="pending">Pending</button>
        <button class="tab-btn" data-status="active">Active</button>
        <button class="tab-btn" data-status="inactive">Inactive</button>
    </div>
    <input type="text" class="search-input" id="searchInput" placeholder="Search users..." oninput="debounceSearch()">
</div>

<table class="data-table" id="usersTable">
    <thead>
        <tr>
            <th>Name</th>
            <th>Email</th>
            <th>Status</th>
            <th>Groups</th>
            <th>Admin</th>
            <th>Last Login</th>
            <th>Actions</th>
        </tr>
    </thead>
    <tbody></tbody>
</table>

<div class="pagination" id="pagination"></div>

<!-- Create User Modal -->
<div class="modal-backdrop" id="createModal" style="display:none;" onclick="if(event.target===this)hideModal('createModal')">
    <div class="modal">
        <h3>Create User</h3>
        <div id="createError" class="alert alert-error" style="display:none;"></div>
        <form onsubmit="return createUser(event)">
            <div class="form-group"><label>Name</label><input type="text" id="newName" required></div>
            <div class="form-group"><label>Email</label><input type="email" id="newEmail" required></div>
            <div class="form-group"><label>Password</label><input type="password" id="newPassword" required minlength="12"><small class="form-hint">Minimum 12 characters</small></div>
            <div class="form-row">
                <label class="checkbox-label"><input type="checkbox" id="newAdmin"> Admin</label>
                <label class="checkbox-label"><input type="checkbox" id="newApproved" checked> Pre-approved</label>
            </div>
            <div class="modal-actions">
                <button type="button" class="btn btn-secondary" onclick="hideModal('createModal')">Cancel</button>
                <button type="submit" class="btn btn-primary">Create</button>
            </div>
        </form>
    </div>
</div>

<!-- Edit User Modal -->
<div class="modal-backdrop" id="editModal" style="display:none;" onclick="if(event.target===this)hideModal('editModal')">
    <div class="modal">
        <h3 id="editTitle">Edit User</h3>
        <div id="editError" class="alert alert-error" style="display:none;"></div>
        <form onsubmit="return updateUser(event)">
            <input type="hidden" id="editId">
            <div class="form-group"><label>Name</label><input type="text" id="editName" required></div>
            <div class="form-row">
                <label class="checkbox-label"><input type="checkbox" id="editAdmin"> Admin</label>
                <label class="checkbox-label"><input type="checkbox" id="editActive"> Active</label>
                <label class="checkbox-label"><input type="checkbox" id="editApproved"> Approved</label>
            </div>
            <div class="form-group">
                <label>Groups</label>
                <div id="editGroups" class="checkbox-grid"></div>
            </div>
            <div class="modal-actions">
                <button type="button" class="btn btn-danger" onclick="deleteUser()">Delete</button>
                <button type="button" class="btn btn-secondary" onclick="hideModal('editModal')">Cancel</button>
                <button type="submit" class="btn btn-primary">Save</button>
            </div>
        </form>
    </div>
</div>
{% endblock %}

{% block extra_js %}
<script>
let currentStatus = '';
let currentPage = 1;
let searchTimeout;
let allGroups = [];

function debounceSearch() {
    clearTimeout(searchTimeout);
    searchTimeout = setTimeout(() => { currentPage = 1; loadUsers(); }, 300);
}

document.querySelectorAll('.tab-btn').forEach(btn => {
    btn.addEventListener('click', () => {
        document.querySelectorAll('.tab-btn').forEach(b => b.classList.remove('active'));
        btn.classList.add('active');
        currentStatus = btn.dataset.status;
        currentPage = 1;
        loadUsers();
    });
});

async function loadUsers() {
    const search = document.getElementById('searchInput').value;
    let url = `/users?page=${currentPage}&per_page=25`;
    if (currentStatus) url += `&status=${currentStatus}`;
    if (search) url += `&search=${encodeURIComponent(search)}`;

    const data = await apiFetch(url);
    if (!data) return;

    const tbody = document.querySelector('#usersTable tbody');
    tbody.innerHTML = '';

    for (const u of data.users) {
        const tr = document.createElement('tr');
        const statusBadge = !u.is_active ? '<span class="badge badge-red">Inactive</span>' :
                           !u.is_approved ? '<span class="badge badge-yellow">Pending</span>' :
                           '<span class="badge badge-green">Active</span>';
        const groups = u.groups.map(g => g.name).join(', ') || '-';
        const lastLogin = u.last_login ? new Date(u.last_login + 'Z').toLocaleDateString() : 'Never';
        tr.innerHTML = `
            <td><strong>${u.name}</strong></td>
            <td>${u.email}</td>
            <td>${statusBadge}</td>
            <td>${groups}</td>
            <td>${u.is_admin ? '<span class="badge badge-blue">Admin</span>' : '-'}</td>
            <td>${lastLogin}</td>
            <td>
                <button class="btn btn-small" onclick="editUser(${u.id})">Edit</button>
                ${!u.is_approved ? `<button class="btn btn-small btn-success" onclick="quickApprove(${u.id})">Approve</button>` : ''}
            </td>`;
        tbody.appendChild(tr);
    }

    // Pagination
    const pag = document.getElementById('pagination');
    pag.innerHTML = '';
    if (data.pages > 1) {
        for (let i = 1; i <= data.pages; i++) {
            const btn = document.createElement('button');
            btn.className = 'btn btn-small' + (i === currentPage ? ' active' : '');
            btn.textContent = i;
            btn.onclick = () => { currentPage = i; loadUsers(); };
            pag.appendChild(btn);
        }
    }
}

async function loadGroups() {
    const data = await apiFetch('/groups');
    if (data) allGroups = data.groups;
}

function showCreateModal() {
    document.getElementById('newName').value = '';
    document.getElementById('newEmail').value = '';
    document.getElementById('newPassword').value = '';
    document.getElementById('newAdmin').checked = false;
    document.getElementById('newApproved').checked = true;
    document.getElementById('createError').style.display = 'none';
    document.getElementById('createModal').style.display = 'flex';
}

function hideModal(id) {
    document.getElementById(id).style.display = 'none';
}

async function createUser(e) {
    e.preventDefault();
    const res = await apiFetch('/users', {
        method: 'POST',
        body: JSON.stringify({
            name: document.getElementById('newName').value,
            email: document.getElementById('newEmail').value,
            password: document.getElementById('newPassword').value,
            is_admin: document.getElementById('newAdmin').checked,
            is_approved: document.getElementById('newApproved').checked,
        }),
    });
    if (res && res.ok) {
        hideModal('createModal');
        loadUsers();
    } else if (res) {
        document.getElementById('createError').textContent = res.detail || 'Failed';
        document.getElementById('createError').style.display = 'block';
    }
}

async function editUser(userId) {
    const user = await apiFetch(`/users/${userId}`);
    if (!user) return;

    document.getElementById('editId').value = user.id;
    document.getElementById('editTitle').textContent = `Edit: ${user.name}`;
    document.getElementById('editName').value = user.name;
    document.getElementById('editAdmin').checked = !!user.is_admin;
    document.getElementById('editActive').checked = !!user.is_active;
    document.getElementById('editApproved').checked = !!user.is_approved;
    document.getElementById('editError').style.display = 'none';

    // Groups checkboxes
    const userGroupIds = user.groups.map(g => g.id);
    const groupsDiv = document.getElementById('editGroups');
    groupsDiv.innerHTML = '';
    for (const g of allGroups) {
        const label = document.createElement('label');
        label.className = 'checkbox-label';
        label.innerHTML = `<input type="checkbox" value="${g.id}" ${userGroupIds.includes(g.id) ? 'checked' : ''}> ${g.name}`;
        groupsDiv.appendChild(label);
    }

    document.getElementById('editModal').style.display = 'flex';
}

async function updateUser(e) {
    e.preventDefault();
    const userId = document.getElementById('editId').value;

    // Update user fields
    const res = await apiFetch(`/users/${userId}`, {
        method: 'POST',
        body: JSON.stringify({
            name: document.getElementById('editName').value,
            is_admin: document.getElementById('editAdmin').checked,
            is_active: document.getElementById('editActive').checked,
            is_approved: document.getElementById('editApproved').checked,
        }),
    });

    // Update groups
    const groupIds = Array.from(document.querySelectorAll('#editGroups input:checked')).map(cb => parseInt(cb.value));
    await apiFetch(`/users/${userId}/groups`, {
        method: 'POST',
        body: JSON.stringify({group_ids: groupIds}),
    });

    if (res && res.ok) {
        hideModal('editModal');
        loadUsers();
    } else if (res) {
        document.getElementById('editError').textContent = res.detail || 'Failed';
        document.getElementById('editError').style.display = 'block';
    }
}

async function deleteUser() {
    const userId = document.getElementById('editId').value;
    if (!confirm('Are you sure you want to delete this user? This cannot be undone.')) return;
    await apiFetch(`/users/${userId}`, {method: 'DELETE'});
    hideModal('editModal');
    loadUsers();
}

async function quickApprove(userId) {
    await apiFetch(`/users/${userId}`, {
        method: 'POST',
        body: JSON.stringify({is_approved: true}),
    });
    loadUsers();
}

loadGroups();
loadUsers();
</script>
{% endblock %}
