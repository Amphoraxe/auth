{% extends "base.html" %}
{% block title %}Dashboard - Amphoraxe Auth{% endblock %}

{% block content %}
<div class="page-title">
    <h2>Dashboard</h2>
</div>

<div class="stats-grid" id="statsGrid">
    <div class="stat-card">
        <div class="stat-value" id="statSessions">--</div>
        <div class="stat-label">Active Sessions</div>
    </div>
    <div class="stat-card">
        <div class="stat-value" id="statUsers">--</div>
        <div class="stat-label">Total Users</div>
    </div>
    <div class="stat-card">
        <div class="stat-value" id="statPending">--</div>
        <div class="stat-label">Pending Approvals</div>
    </div>
    <div class="stat-card">
        <div class="stat-value" id="statLogins">--</div>
        <div class="stat-label">Logins (24h)</div>
    </div>
    <div class="stat-card">
        <div class="stat-value" id="statApps">--</div>
        <div class="stat-label">Active Apps</div>
    </div>
</div>

<div class="card">
    <h3>Service Health</h3>
    <div class="health-grid" id="healthGrid"></div>
</div>

<div class="card">
    <h3>AMP LLM Runner</h3>
    <div id="runnerInfo" class="runner-info">
        <div class="runner-loading">Loading runner status...</div>
    </div>
</div>

<div class="card">
    <h3>Recent Activity</h3>
    <table class="data-table" id="activityTable">
        <thead>
            <tr><th>Time</th><th>User</th><th>Action</th><th>App</th><th>Details</th></tr>
        </thead>
        <tbody></tbody>
    </table>
</div>
{% endblock %}

{% block extra_js %}
<script>
async function loadDashboard() {
    const data = await apiFetch('/audit/stats');
    if (!data) return;

    document.getElementById('statSessions').textContent = data.active_sessions;
    document.getElementById('statUsers').textContent = data.total_users;
    document.getElementById('statPending').textContent = data.pending_approvals;
    document.getElementById('statLogins').textContent = data.logins_24h;
    document.getElementById('statApps').textContent = data.active_apps;

    // Pending badge
    if (data.pending_approvals > 0) {
        document.getElementById('statPending').classList.add('stat-warning');
    }

    // Recent activity
    const tbody = document.querySelector('#activityTable tbody');
    tbody.innerHTML = '';
    for (const entry of data.recent_activity) {
        const tr = document.createElement('tr');
        const time = new Date(entry.created_at + 'Z').toLocaleString();
        tr.innerHTML = `<td>${time}</td><td>${entry.user_email || '-'}</td><td><code>${entry.action}</code></td><td>${entry.app_slug || '-'}</td><td class="details-cell">${entry.details || '-'}</td>`;
        tbody.appendChild(tr);
    }
}

// All services across the ecosystem
const SERVICES = [
    { group: 'Auth', name: 'Auth API', port: 8300 },
    { group: 'Website', name: 'amphoraxe.ca', port: 8880, path: '/' },
    { group: 'AMP LLM', name: 'Webapp', port: 8000 },
    { group: 'AMP LLM', name: 'Chat API', port: 8001 },
    { group: 'AMP LLM', name: 'NCT Lookup', port: 8002 },
    { group: 'AMP LLM', name: 'Runner', port: 8003 },
    { group: 'AMP LLM', name: 'Assistant', port: 8004 },
    { group: 'VC DataRoom', name: 'Webapp', port: 8100 },
    { group: 'dbAMP', name: 'Webapp', port: 8200 },
    { group: 'Analytics', name: 'Umami', port: 3000, path: '/api/heartbeat' },
];

async function checkHealth() {
    const grid = document.getElementById('healthGrid');
    grid.innerHTML = '';

    // Group services
    const groups = {};
    for (const svc of SERVICES) {
        if (!groups[svc.group]) groups[svc.group] = [];
        groups[svc.group].push(svc);
    }

    for (const [groupName, svcs] of Object.entries(groups)) {
        const groupDiv = document.createElement('div');
        groupDiv.className = 'health-group';
        groupDiv.innerHTML = `<div class="health-group-title">${groupName}</div>`;

        for (const svc of svcs) {
            const div = document.createElement('div');
            div.className = 'health-item';
            div.innerHTML = `<span class="health-icon health-checking"></span><span class="health-name">${svc.name}</span><span class="health-port">:${svc.port}</span>`;
            groupDiv.appendChild(div);

            (async () => {
                try {
                    const params = new URLSearchParams({port: svc.port});
                    if (svc.path) params.set('path', svc.path);
                    const res = await fetch(`/api/v1/health-proxy?${params}`, {credentials: 'include'});
                    const icon = div.querySelector('.health-icon');
                    icon.classList.remove('health-checking');
                    icon.classList.add(res.ok ? 'health-up' : 'health-down');
                } catch {
                    const icon = div.querySelector('.health-icon');
                    icon.classList.remove('health-checking');
                    icon.classList.add('health-down');
                }
            })();
        }
        grid.appendChild(groupDiv);
    }
}

async function loadRunnerInfo() {
    const el = document.getElementById('runnerInfo');
    try {
        const [healthRes, csvRes, jobsRes] = await Promise.all([
            fetch('/api/v1/health-proxy?port=8003&path=/health', {credentials: 'include'}),
            fetch('/api/v1/health-proxy?port=8003&path=/csv-files', {credentials: 'include'}),
            fetch('/api/v1/health-proxy?port=8000&path=/api/chat/jobs', {credentials: 'include'}),
        ]);

        if (!healthRes.ok) {
            el.innerHTML = '<div class="runner-offline">Runner service offline</div>';
            return;
        }

        const health = await healthRes.json();
        const csvData = csvRes.ok ? await csvRes.json() : {total_files: 0, files: []};
        const jobsData = jobsRes.ok ? await jobsRes.json() : {jobs: [], total: 0, active: 0};

        const nct = health.nct_service || {};
        const llm = health.llm_assistant || {};
        const ollama = (llm.features || {}).ollama || {};
        const storage = health.storage || {};

        let html = '<div class="runner-stats">';
        html += `<div class="runner-stat"><span class="runner-stat-value">${storage.files_count || 0}</span><span class="runner-stat-label">NCT Data Files</span></div>`;
        html += `<div class="runner-stat"><span class="runner-stat-value">${csvData.total_files || 0}</span><span class="runner-stat-label">CSV Exports</span></div>`;
        html += `<div class="runner-stat"><span class="runner-stat-value">${ollama.models_count || '?'}</span><span class="runner-stat-label">Ollama Models</span></div>`;
        html += `<div class="runner-stat"><span class="runner-stat-value ${jobsData.active > 0 ? 'stat-active' : ''}">${jobsData.active || 0}</span><span class="runner-stat-label">Active Jobs</span></div>`;
        html += '</div>';

        html += '<div class="runner-deps">';
        html += `<div class="runner-dep"><span class="health-icon ${nct.connected ? 'health-up' : 'health-down'}"></span>NCT Service <span class="health-port">${nct.url || ':8002'}</span></div>`;
        html += `<div class="runner-dep"><span class="health-icon ${llm.connected ? 'health-up' : 'health-down'}"></span>LLM Assistant <span class="health-port">${llm.url || ':8004'}</span></div>`;
        html += `<div class="runner-dep"><span class="health-icon ${ollama.connected ? 'health-up' : 'health-down'}"></span>Ollama <span class="health-port">${ollama.url || ':11434'}</span></div>`;
        html += '</div>';

        // Jobs list
        if (jobsData.jobs && jobsData.jobs.length > 0) {
            html += '<div class="runner-jobs"><div class="runner-csv-title">Jobs</div>';
            for (const job of jobsData.jobs) {
                const elapsed = job.elapsed_seconds;
                const mins = Math.floor(elapsed / 60);
                const secs = elapsed % 60;
                const time = mins > 0 ? `${mins}m ${secs}s` : `${secs}s`;
                const statusCls = job.status === 'processing' ? 'job-active' :
                                  job.status === 'completed' ? 'job-done' :
                                  job.status === 'failed' ? 'job-failed' : 'job-pending';
                html += `<div class="runner-job">`;
                html += `<div class="runner-job-header"><span class="job-status ${statusCls}">${job.status}</span>`;
                html += `<span class="job-file">${job.original_filename || 'unnamed'}</span>`;
                html += `<span class="job-branch">${job.branch || 'main'}</span></div>`;
                html += `<div class="runner-job-detail">`;
                html += `<span>${job.progress || ''}</span>`;
                html += `<span class="health-port">${job.model} &middot; ${time}</span>`;
                html += `</div>`;
                if (job.status === 'processing' && job.total_trials > 0) {
                    html += `<div class="job-progress-bar"><div class="job-progress-fill" style="width:${job.percent_complete}%"></div></div>`;
                }
                html += `</div>`;
            }
            html += '</div>';
        }

        if (csvData.files && csvData.files.length > 0) {
            html += '<div class="runner-csv-list"><div class="runner-csv-title">Recent CSV Exports</div>';
            for (const f of csvData.files.slice(0, 5)) {
                const date = new Date(f.created).toLocaleString();
                html += `<div class="runner-csv-item"><span>${f.filename}</span><span class="health-port">${f.size_kb.toFixed(1)} KB &middot; ${date}</span></div>`;
            }
            html += '</div>';
        }

        el.innerHTML = html;
    } catch {
        el.innerHTML = '<div class="runner-offline">Could not reach runner service</div>';
    }
}

// Auto-refresh runner info every 10s
setInterval(loadRunnerInfo, 10000);

loadDashboard();
checkHealth();
loadRunnerInfo();
</script>
{% endblock %}
