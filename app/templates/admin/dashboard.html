{% extends "base.html" %}
{% block title %}Dashboard - Amphoraxe Auth{% endblock %}

{% block content %}
<div class="page-title">
    <h2>Dashboard</h2>
</div>

<div class="stats-grid" id="statsGrid">
    <div class="stat-card">
        <div class="stat-value" id="statSessions">--</div>
        <div class="stat-label">Active Sessions</div>
    </div>
    <div class="stat-card">
        <div class="stat-value" id="statUsers">--</div>
        <div class="stat-label">Total Users</div>
    </div>
    <div class="stat-card">
        <div class="stat-value" id="statPending">--</div>
        <div class="stat-label">Pending Approvals</div>
    </div>
    <div class="stat-card">
        <div class="stat-value" id="statLogins">--</div>
        <div class="stat-label">Logins (24h)</div>
    </div>
    <div class="stat-card">
        <div class="stat-value" id="statApps">--</div>
        <div class="stat-label">Active Apps</div>
    </div>
</div>

<div class="card">
    <h3>Service Health</h3>
    <div class="health-grid" id="healthGrid"></div>
</div>

<div class="card">
    <h3>Recent Activity</h3>
    <table class="data-table" id="activityTable">
        <thead>
            <tr><th>Time</th><th>User</th><th>Action</th><th>App</th><th>Details</th></tr>
        </thead>
        <tbody></tbody>
    </table>
</div>
{% endblock %}

{% block extra_js %}
<script>
async function loadDashboard() {
    const data = await apiFetch('/audit/stats');
    if (!data) return;

    document.getElementById('statSessions').textContent = data.active_sessions;
    document.getElementById('statUsers').textContent = data.total_users;
    document.getElementById('statPending').textContent = data.pending_approvals;
    document.getElementById('statLogins').textContent = data.logins_24h;
    document.getElementById('statApps').textContent = data.active_apps;

    // Pending badge
    if (data.pending_approvals > 0) {
        document.getElementById('statPending').classList.add('stat-warning');
    }

    // Recent activity
    const tbody = document.querySelector('#activityTable tbody');
    tbody.innerHTML = '';
    for (const entry of data.recent_activity) {
        const tr = document.createElement('tr');
        const time = new Date(entry.created_at + 'Z').toLocaleString();
        tr.innerHTML = `<td>${time}</td><td>${entry.user_email || '-'}</td><td><code>${entry.action}</code></td><td>${entry.app_slug || '-'}</td><td class="details-cell">${entry.details || '-'}</td>`;
        tbody.appendChild(tr);
    }
}

// All services across the ecosystem
const SERVICES = [
    { group: 'Auth', name: 'Auth API', port: 8300 },
    { group: 'Website', name: 'amphoraxe.ca', port: 8880 },
    { group: 'AMP LLM', name: 'Webapp', port: 8000 },
    { group: 'AMP LLM', name: 'Chat API', port: 8001 },
    { group: 'AMP LLM', name: 'NCT Lookup', port: 8002 },
    { group: 'AMP LLM', name: 'Runner', port: 8003 },
    { group: 'AMP LLM', name: 'Assistant', port: 8004 },
    { group: 'VC DataRoom', name: 'Webapp', port: 8100 },
    { group: 'dbAMP', name: 'Webapp', port: 8200 },
    { group: 'Analytics', name: 'Umami', port: 3000 },
];

async function checkHealth() {
    const grid = document.getElementById('healthGrid');
    grid.innerHTML = '';

    // Group services
    const groups = {};
    for (const svc of SERVICES) {
        if (!groups[svc.group]) groups[svc.group] = [];
        groups[svc.group].push(svc);
    }

    for (const [groupName, svcs] of Object.entries(groups)) {
        const groupDiv = document.createElement('div');
        groupDiv.className = 'health-group';
        groupDiv.innerHTML = `<div class="health-group-title">${groupName}</div>`;

        for (const svc of svcs) {
            const div = document.createElement('div');
            div.className = 'health-item';
            div.innerHTML = `<span class="health-icon health-checking"></span><span class="health-name">${svc.name}</span><span class="health-port">:${svc.port}</span>`;
            groupDiv.appendChild(div);

            (async () => {
                try {
                    const res = await fetch(`/api/v1/health-proxy?port=${svc.port}`, {credentials: 'include'});
                    const icon = div.querySelector('.health-icon');
                    icon.classList.remove('health-checking');
                    icon.classList.add(res.ok ? 'health-up' : 'health-down');
                } catch {
                    const icon = div.querySelector('.health-icon');
                    icon.classList.remove('health-checking');
                    icon.classList.add('health-down');
                }
            })();
        }
        grid.appendChild(groupDiv);
    }
}

loadDashboard();
checkHealth();
</script>
{% endblock %}
